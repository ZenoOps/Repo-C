
name: Sync Source Repositories

# This workflow is triggered by an API event, not a push
on:
  repository_dispatch:
    types: [source-repo-updated] # A custom name for our event
  
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  sync-and-merge:
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.ref == 'refs/heads/ubstable-release' && 'MAIN' }}

    steps:
      - name: 1. Checkout the mono repo (Repo-C)
        uses: actions/checkout@v4
        with:
          # Check out the branch we intend to push to
          ref: ${{ secrets.TARGET_BRANCH }}
          # We need a PAT with 'repo' scope to push back
          # GITHUB_TOKEN will not work for this push
          token: ${{ secrets.ACCESS_TOKEN }} 

      - name: 2. Checkout agentric-unstructured-ui (Source repo)
        uses: actions/checkout@v4
        with:
          repository: ZenoOps/unstructured-frontend #name of the source repository
          # Use the same PAT to access the private repo
          token: ${{ secrets.ACCESS_TOKEN }} 
          # Clone source repo's contents into a subfolder named 'agentric-unstructured-ui'
          path: 'agentric-unstructured-ui'  

      - name: 3. Checkout agentric-unstructured (Source repo)
        uses: actions/checkout@v4
        with:
          repository: ZenoOps/unstructured_backend #name of the source repository
          token: ${{ secrets.ACCESS_TOKEN }}
          path: 'agentric-unstructured'

      - name: 4. Commit and Push Changes
        run: |
          echo " Setting the author identity locally "
          git config user.name 'ZenoOps'
          git config user.email 'kyawsoe.thet27@gmail.com'
          
          echo " Removing the .git folder tagged along during the checking out process "
          rm -rf ./agentric-unstructured-ui/.git
          rm -rf ./agentric-unstructured/.git
          
          echo " Adding the respective folders to push "
          git add ./agentric-unstructured-ui/ ./agentric-unstructured/

          echo " checking if there are any changes to push "
          if git diff --staged --quiet; then
            echo "âœ… No changes detected from source repos. Exiting."
          else
            echo "Changes detected. Committing and pushing..."
            git commit -m "Automated: Sync content from source repos"
            git push origin ${{ vars.TARGET_BRANCH }}
            echo "ðŸš€ Changes pushed successfully."
          fi
